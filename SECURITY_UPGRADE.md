# تقرير ترقية أمن النظام (Security Upgrade Report)

هذا المستند يشرح التعديلات الأمنية المتقدمة التي تم تطبيقها على المشروع للوصول إلى مستويات أمان تحاكي الأنظمة البنكية والمالية.

---

## 1. الأهداف الرئيسية للتطوير
*   **حماية الجلسات:** منع بقاء الجلسات مفتوحة للأبد دون نشاط.
*   **الوقاية من هجمات XSS:** منع سرقة التوكنات عن طريق الجافا سكريبت الخبيثة.
*   **تحسين تجربة المستخدم:** الحفاظ على تسجيل الدخول طالما المستخدم نشط دون الحاجة لإعادة كتابة كلمة المرور.

---

## 2. ما الذي تمت إضافته وتعديله؟

### أ. على مستوى الخلفية (Backend - Auth Service)
1.  **نظام التوكن المزدوج (Dual Token Strategy):**
    *   تم تقليل صلاحية الـ `Access Token` إلى **5 دقائق** فقط.
    *   تم إنشاء `Refresh Token` بصلاحية **24 ساعة**.
2.  **قاعدة بيانات الجلسات:**
    *   إضافة جدول `RefreshToken` في قاعدة البيانات لربط التوكن بالمستخدم والتحقق من صلاحيته.
3.  **تكنولوجيا HttpOnly Cookies:**
    *   بدلاً من إرسال التوكن الطويل في الرد (Response Body)، يتم إرساله الآن عبر "كوكي" مشفرة بنوع `HttpOnly`.
    *   **لماذا؟** لأن المتصفح يمنع أي كود جافا سكريبت من الوصول لهذه الكوكي، مما يجعل سرقتها مستحيلة تقنياً من داخل المتصفح.
4.  **نقاط نهاية (Endpoints) جديدة:**
    *   `/auth/refreshtoken`: لتجديد الجلسة باستخدام الكوكي المشفرة.
    *   `/auth/logout`: لمسح الكوكي من المتصفح وتعطيل التوكن في قاعدة البيانات.

### ب. على مستوى الواجهة الأمامية (Frontend - Next.js)
1.  **مستشعر النشاط (Activity Sensor):**
    *   تمت إضافة مستمعين (EventListeners) لحركات الماوس، لوحة المفاتيح، واللمس.
    *   إذا توقف النشاط لمدة **5 دقائق**، يتم استدعاء وظيفة `logout()` تلقائياً.
2.  **التجديد الصامت (Silent Refresh):**
    *   تم ضبط مؤقت (Timer) يقوم بطلب توكن جديد كل **4 دقائق** طالما المتصفح مفتوح والمستخدم نشط.
3.  **أمن الطلبات (Credentials):**
    *   تحديث جميع طلبات الـ API لتشمل `credentials: 'include'`، وهو الخيار الذي يسمح بإرسال الكوكيز المشفرة مع الطلبات.

---

## 3. التأثير على الواجهة وتجربة المستخدم
*   **الشكل:** لا يوجد تغيير مرئي في التصميم، لكن النظام أصبح "أذكى".
*   **تسجيل الخروج:** ستلاحظ أنه عند ترك الصفحة والعودة بعد مدة، سيتم تحويلك لصفحة الدخول تلقائياً (حماية للبيانات).
*   **الاستقرار:** لن تنقطع جلستك فجأة طالما أنت تستخدم الموقع، لأن التجديد يتم في الخلفية دون شعورك.

---

## 4. ملخص الخطوات التقنية للمراجعة والتعلم
1.  **Entity:** إنشاء `RefreshToken.java` لتخزين التوكن.
2.  **Configuration:** تعديل `application.yml` لضبط أوقات انتهاء الصلاحية.
3.  **Controller:** إعداد `ResponseCookie` في `AuthController.java` لإرسال الكوكيز المشفرة.
4.  **Context:** تعديل `AuthContext.tsx` لإدارة التجديد التلقائي ومستشعرات النشاط.

---
**النظام الآن جاهز وآمن تماماً!**
