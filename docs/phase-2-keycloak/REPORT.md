# الخطوة 2: نظام الهوية الاحترافي (Identity Provider - Keycloak)

تم الانتهاء من دمج نظام **Keycloak** في معمارية المشروع، وهو نظام مفتوح المصدر رائد عالمياً لإدارة الهوية والوصول (IAM)، وتستخدمه كبرى البنوك والمؤسسات.

---

## 1. لماذا قمنا بهذه الخطوة؟ (Rationale)
بدلاً من بناء نظام أمان كامل من الصفر داخل الكود الخاص بك (والذي قد يحتوي على ثغرات)، قمنا بالاعتماد على "نظام متخصص" يوفر:
*   **عزل الهوية:** بيانات المستخدمين وكلمات مرورهم تُدار في نظام منفصل تماماً عن كود الخدمات (Business Logic).
*   **المعايير العالمية:** يدعم بروتوكولات مثل OAuth2 و OpenID Connect (OIDC).
*   **الميزات الجاهزة:** يوفر واجهة إدارة كاملة (Admin Console) دون الحاجة لكتابة كود واحد.

---

## 2. ما هي المميزات البنكية التي أضفناها؟
بمجرد تشغيل Keycloak، أصبح بإمكانك تفعيل الميزات التالية فوراً من لوحة التحكم:
*   **MFA (Multi-Factor Authentication):** طلب رمز من تطبيق Google Authenticator عند الدخول.
*   **Brute Force Protection:** قفل الحساب تلقائياً بعد 5 محاولات خاطئة لمنع هجمات التخمين.
*   **Audit Logging:** سجل كامل لكل عملية دخول، خروج، أو محاولة اختراق فاشلة.
*   **Password Policies:** إجبار المستخدمين على اختيار كلمات مرور معقدة (أحرف كبيرة، أرقام، رموز).

---

## 3. كيف تم التحديث؟ (Implementation)
1.  **البنية التحتية:** إضافة `keycloak` كخدمة في `docker-compose.yml` مع قاعدة بيانات Postgres خاصة به.
2.  **دمج البوابة (Gateway Security):** تحويل الـ `api-gateway` من مجرد موجه طلبات إلى **Resource Server**. البوابة الآن ترفض أي طلب لا يحمل توكن (JWT) صالح صادر من Keycloak.
3.  **إعدادات Spring:** تم إضافة مكتبة `spring-boot-starter-oauth2-resource-server` للبوابة وتكوينها لتتحقق من صحة التوكنات مباشرة من سيرفر Keycloak.

---

## 4. الفائدة المحققة
*   **أمان ضد التزييف:** لا يمكن لأي شخص تزوير توكن، لأن البوابة تتحقق من التوقيع الرقمي للتوكن باستخدام مفاتيح Keycloak العامة.
*   **سهولة التوسع:** إذا أردت إضافة تطبيق موبايل مستقبلاً، سيتحدث بنفس الطريقة مع Keycloak دون الحاجة لتغيير كود الخدمات.

---
**الوضع الحالي:** Keycloak يعمل على المنفذ `8087` باسم مستخدم `admin` وكلمة مرور `admin`. البوابة الآن محصنة ولا تمرر الطلبات إلا للمصرح لهم.
